ARGOCD_USER_KEY = 'ARGOCD_USER'
ARGOCD_PASSWORD_KEY = 'ARGOCD_PASSWORD'
DOCKER_IP_KEY = 'DOCKER_IP'
DOCKER_GID_KEY = 'DOCKER_GID'
GITLAB_HOST_KEY = 'GITLAB_HOST'
GITLAB_URL_KEY = 'GITLAB_URL'
GITLAB_API_BASE_URL_KEY = 'GITLAB_API_BASE_URL'
GITLAB_USER_KEY = 'GITLAB_USER'
GITLAB_PASSWORD_KEY = 'GITLAB_PASSWORD'
GITLAB_GROUP_KEY = 'GITLAB_GROUP'
GITLAB_API_KEY_KEY = 'GITLAB_API_KEY'
GITLAB_RUNNER_API_KEY_KEY = 'GITLAB_RUNNER_API_KEY'
GITLAB_CLIENT_ID_KEY = 'GITLAB_CLIENT_ID'
GITLAB_CLIENT_SECRET_KEY = 'GITLAB_CLIENT_SECRET'
GITLAB_SCRIPTS_DIR_KEY = 'GITLAB_SCRIPTS_DIR'
GITLAB_TEMPLATES_DIR_KEY = 'GITLAB_TEMPLATES_DIR'
POSTGRES_EXTENSIONS_KEY = 'POSTGRES_EXTENSIONS'
POSTGRES_DB_KEY = 'POSTGRES_DB'
POSTGRES_USER_KEY = 'POSTGRES_USER'
POSTGRES_PASSWORD_KEY = 'POSTGRES_PASSWORD'
POSTGRES_HOST_AUTH_METHOD_KEY = 'POSTGRES_HOST_AUTH_METHOD'
KUBERNETES_API_BASE_URL_KEY = 'KUBERNETES_API_BASE_URL'
KUBERNETES_CLUSTER_NAME_KEY = 'KUBERNETES_CLUSTER_NAME'
KUBERNETES_SKIP_TLS_KEY = 'KUBERNETES_SKIP_TLS'
KUBERNETES_SKIP_METRICS_KEY = 'KUBERNETES_SKIP_METRICS'
KUBERNETES_CLIENT_CERTIFICATE_DATA_KEY = 'KUBERNETES_CLIENT_CERTIFICATE_DATA'
KUBERNETES_CLIENT_KEY_DATA_KEY = 'KUBERNETES_CLIENT_KEY_DATA'

ARGOCD_USER_VALUE = 'admin'
ARGOCD_PASSWORD_VALUE = local(command='kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d && echo')
DOCKER_IP_VALUE = local(command='docker network inspect bridge --format="{{(index .IPAM.Config 0).Gateway}}"')
DOCKER_GID_VALUE = local(command='getent group docker | cut -d: -f3')
GITLAB_HOST_VALUE = 'gitlab-local'
GITLAB_URL_VALUE = 'http://' + GITLAB_HOST_VALUE
GITLAB_API_BASE_URL_VALUE = GITLAB_URL_VALUE + '/api/v4'
GITLAB_USER_VALUE = 'root'
GITLAB_PASSWORD_VALUE = '-rob123-'
GITLAB_GROUP_VALUE = 'backstage-demo'
GITLAB_API_KEY_VALUE = 'glpat-zQ-yQ8VyW37oRSbEnWAx'
GITLAB_CLIENT_ID_VALUE = 'd3ea15baea5a9d72ed6a5fa2e42c71140a634bc374b0b0aaa01066a87e62ec62'
GITLAB_CLIENT_SECRET_VALUE = 'gloas-b1f8c16b11c2a90737b678ec970e0f0247aee65ae886e7dce89c65ae29a6bf67'
GITLAB_SCRIPTS_DIR_VALUE = '/scripts'
GITLAB_TEMPLATES_DIR_VALUE = GITLAB_SCRIPTS_DIR_VALUE + '/templates'
POSTGRES_EXTENSIONS_VALUE = 'pg_trgm,btree_gist'
POSTGRES_DB_VALUE = 'gitlabhq_production'
POSTGRES_USER_VALUE = 'gitlab'
POSTGRES_PASSWORD_VALUE = 'password'
POSTGRES_HOST_AUTH_METHOD_VALUE = 'trust'
KUBERNETES_API_BASE_URL_VALUE = 'https://kind-backstage-demo-cluster-local:6443'
KUBERNETES_CLUSTER_NAME_VALUE = 'kind-backstage-demo-cluster'
KUBERNETES_SKIP_TLS_VALUE = 'true'
KUBERNETES_SKIP_METRICS_VALUE = 'true'
KUBERNETES_CLIENT_CERTIFICATE_DATA_VALUE = 'LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCVENDQWUyZ0F3SUJBZ0lJUnJYNXJXNlJNNjR3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TkRFeE1qY3dNVEUwTVRaYUZ3MHpOREV4TWpVd01URTVNVFphTUJVeApFekFSQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUUNkd2I5cEVFV0FLZGw5cnBGTlRiMXhJRnJ0bS9iVjZBdU9QbXNsYjBuMzVpVlRYYU93TGZmQ2ZaVTAKSU5INXU1aTk5ZFQ2UGs2c3RIak1LTFBzZUdrQ09OUGZFVitUbXd5Y0dONTRiV3o3emFLS01wck5pUmhJR2pERQpOR3hJY3BtbDZxV1I3eEtZR1lkRGxjaUtUNzdmWUQ4Q1dObC9jL3RYLy9QZStNbjdUZitQdTR3NURheTU2MERrCjg2KzVDSDNtOGNRTnZCaFM0bGN6YUcyTHdwdFp6bmJKcSsvMUhkZWJzTjVONmJ0OGZEV0ZNMlBGZ3lBK1B1bTcKUUlSb2prdld1Z3hCSFVsbjJseVE0QTBwR2VTeWl4dzRCdEVzQ2dQbThEWU1zaC9ZeEM1WHpsN3NZWnYvUWRvZQorSkpvM1U2eWZaeng2ZDl0a3ZnUmpCUzZ0Q3p2QWdNQkFBR2pXVEJYTUE0R0ExVWREd0VCL3dRRUF3SUNwREFQCkJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXQkJSMlBQdktkRTBVRXdFN3FUVGJ5L3YzNk1CakpEQVYKQmdOVkhSRUVEakFNZ2dwcmRXSmxjbTVsZEdWek1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQU5LS01HdWdqYwpPMnFXaS93R3pCMzZMazA2NWtCRjFwd1NVY2xyQUdnZjNSeTUzaVpGMlRSWDBBLzZKRm9UbXdXbEtzYk5uVFR4CkxsVmhadzBwRkdDYk9uWURCaEpkNUtEUEFJZVd5YXgyQSt1TlpJRzE5MjJwN2taakI0dWNwOWJUaEhhN3MrdVAKV2ZMWG90eXlOZlZzL2lGeDNlelFyK0tFb0NwckJkNWZSbVd1Z0IrNWxrczNSbFRDKzFhRU02SUYzWjZtbE1lQgpYMUZESmNFamg1T1d5V0g4QzR0Qm85a3pZNGl2WjFlY1NUREd5UlZNdURRb3lCTk8vdGUyMldKU1VZdzYxc3R4CkpScU9GQkdWWEhuSkpVM3REZm9JZlorVUR4OFEzcTRzRkF4MXIrUnlJUUgvNGhreUhYNCs5NHlIUE5XZmZGZ0sKNmFoZnN6Vjd0YkhpCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K'
KUBERNETES_CLIENT_KEY_DATA_VALUE = 'eyJhbGciOiJSUzI1NiIsImtpZCI6Ik1URTlzUTg1Qnd2ZmlXUGFvZVdWR0tIM1oyRk5FNXpNaGFxM3BSOUNzV0UifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImJhY2tzdGFnZS1zZWNyZXQiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiYmFja3N0YWdlLXNlcnZpY2UtYWNjb3VudCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjEwYzhhYjU0LTU1NzUtNGIwMC04MDRhLTdiZjU5NGMyODg2YSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmJhY2tzdGFnZS1zZXJ2aWNlLWFjY291bnQifQ.RemKQ1ic3DlSilqguFjciJ3_ahN78dATazOtMzxg9phUlyFQLvbUaqjjAoyDTsgMRFVhZyvE_tRJZG7QQv2J5-51iTtc3R-n5KMcCjj6Ja7KE80aDYyFPJ-ZbAWLjUlUdemz3CmTAMegCi3R6p_rIwhM010gwHBih7Aa0xNHcW-CQxYFp9s8-ZYB7n2-Aca7gEOmlSzm6t-LRbfGfWzKXKGNPHDD9uYEpOIkDUO3X_AUcOxz1gzJFjhX-0mRxAXFX6XdUUi74Uuzyr9maCelUUYky1jkIWU-JLqCZGpdMHlPB__tBJ9W22lZJCjHaviUtWsMIevsd7sRrN9v37Y3Aw'

BUILD_ARGS = {
    ARGOCD_USER_KEY: ARGOCD_USER_VALUE,
    ARGOCD_PASSWORD_KEY: ARGOCD_PASSWORD_VALUE,
    DOCKER_IP_KEY: DOCKER_IP_VALUE,
    DOCKER_GID_KEY: DOCKER_GID_VALUE,
    GITLAB_HOST_KEY: GITLAB_HOST_VALUE,
    GITLAB_URL_KEY: GITLAB_URL_VALUE,
    GITLAB_API_BASE_URL_KEY: GITLAB_API_BASE_URL_VALUE,
    GITLAB_USER_KEY: GITLAB_USER_VALUE,
    GITLAB_PASSWORD_KEY: GITLAB_PASSWORD_VALUE,
    GITLAB_GROUP_KEY: GITLAB_GROUP_VALUE,
    GITLAB_API_KEY_KEY: GITLAB_API_KEY_VALUE,
    GITLAB_CLIENT_ID_KEY: GITLAB_CLIENT_ID_VALUE,
    GITLAB_CLIENT_SECRET_KEY: GITLAB_CLIENT_SECRET_VALUE,
    GITLAB_SCRIPTS_DIR_KEY: GITLAB_SCRIPTS_DIR_VALUE,
    GITLAB_TEMPLATES_DIR_KEY: GITLAB_TEMPLATES_DIR_VALUE,
    POSTGRES_EXTENSIONS_KEY: POSTGRES_EXTENSIONS_VALUE,
    POSTGRES_DB_KEY: POSTGRES_DB_VALUE,
    POSTGRES_USER_KEY: POSTGRES_USER_VALUE,
    POSTGRES_PASSWORD_KEY: POSTGRES_PASSWORD_VALUE,
    POSTGRES_HOST_AUTH_METHOD_KEY: POSTGRES_HOST_AUTH_METHOD_VALUE,
    KUBERNETES_API_BASE_URL_KEY: KUBERNETES_API_BASE_URL_VALUE,
    KUBERNETES_CLUSTER_NAME_KEY: KUBERNETES_CLUSTER_NAME_VALUE,
    KUBERNETES_SKIP_TLS_KEY: KUBERNETES_SKIP_TLS_VALUE,
    KUBERNETES_SKIP_METRICS_KEY: KUBERNETES_SKIP_METRICS_VALUE,
    KUBERNETES_CLIENT_CERTIFICATE_DATA_KEY: KUBERNETES_CLIENT_CERTIFICATE_DATA_VALUE,
    KUBERNETES_CLIENT_KEY_DATA_KEY: KUBERNETES_CLIENT_KEY_DATA_VALUE,
}

os.putenv(ARGOCD_USER_KEY, ARGOCD_USER_VALUE)
os.putenv(ARGOCD_PASSWORD_KEY, ARGOCD_PASSWORD_VALUE)
os.putenv(DOCKER_IP_KEY, DOCKER_IP_VALUE)
os.putenv(DOCKER_GID_KEY, DOCKER_GID_VALUE)
os.putenv(GITLAB_HOST_KEY, GITLAB_HOST_VALUE)
os.putenv(GITLAB_URL_KEY, GITLAB_URL_VALUE)
os.putenv(GITLAB_API_BASE_URL_KEY, GITLAB_API_BASE_URL_VALUE)
os.putenv(GITLAB_USER_KEY, GITLAB_USER_VALUE)
os.putenv(GITLAB_PASSWORD_KEY, GITLAB_PASSWORD_VALUE)
os.putenv(GITLAB_GROUP_KEY, GITLAB_GROUP_VALUE)
os.putenv(GITLAB_API_KEY_KEY, GITLAB_API_KEY_VALUE)
os.putenv(GITLAB_CLIENT_ID_KEY, GITLAB_CLIENT_ID_VALUE)
os.putenv(GITLAB_CLIENT_SECRET_KEY, GITLAB_CLIENT_SECRET_VALUE)
os.putenv(GITLAB_SCRIPTS_DIR_KEY, GITLAB_SCRIPTS_DIR_VALUE)
os.putenv(GITLAB_TEMPLATES_DIR_KEY, GITLAB_TEMPLATES_DIR_VALUE)
os.putenv(POSTGRES_EXTENSIONS_KEY, POSTGRES_EXTENSIONS_VALUE)
os.putenv(POSTGRES_DB_KEY, POSTGRES_DB_VALUE)
os.putenv(POSTGRES_USER_KEY, POSTGRES_USER_VALUE)
os.putenv(POSTGRES_PASSWORD_KEY, POSTGRES_PASSWORD_VALUE)
os.putenv(POSTGRES_HOST_AUTH_METHOD_KEY, POSTGRES_HOST_AUTH_METHOD_VALUE)
os.putenv(KUBERNETES_API_BASE_URL_KEY, KUBERNETES_API_BASE_URL_VALUE)
os.putenv(KUBERNETES_CLUSTER_NAME_KEY, KUBERNETES_CLUSTER_NAME_VALUE)
os.putenv(KUBERNETES_SKIP_TLS_KEY, KUBERNETES_SKIP_TLS_VALUE)
os.putenv(KUBERNETES_SKIP_METRICS_KEY, KUBERNETES_SKIP_METRICS_VALUE)
os.putenv(KUBERNETES_CLIENT_CERTIFICATE_DATA_KEY, KUBERNETES_CLIENT_CERTIFICATE_DATA_VALUE)
os.putenv(KUBERNETES_CLIENT_KEY_DATA_KEY, KUBERNETES_CLIENT_KEY_DATA_VALUE)

docker_build(
    ref = 'gitlab-image',
    context = './gitlab',
    build_args = BUILD_ARGS,
)
docker_build(
    ref = 'gitlab-runner-image',
    context = './gitlab-runner',
    build_args = BUILD_ARGS,
)

docker_build(
    ref = 'backstage-app-image',
    context = '../',
    dockerfile = './backstage-app/Dockerfile',
    only = ['app-config.yaml', './packages/app'],
    live_update = [
        # when package.json changes, we need to do a full build
        fall_back_on(['./packages/app/package.json']),
        # Map the local source code into the container under /src
        sync('./packages/app', '/app'),
        sync('./app-config.yaml', '/app/app-config.yaml'),
    ],
    build_args = BUILD_ARGS
)

docker_build(
    ref = 'backstage-backend-image',
    context = '../',
    dockerfile = './backstage-backend/Dockerfile',
    only = ['app-config.yaml', './packages/backend'],
    live_update=[
        # when package.json changes, we need to do a full build
        fall_back_on(['./packages/backend/package.json']),
        # Map the local source code into the container under /src
        sync('./packages/backend', '/app'),
        sync('./app-config.yaml', '/app/app-config.yaml'),
    ],
    build_args = BUILD_ARGS
)

docker_compose( configPaths = './docker-compose.yaml')

dc_resource(name = 'gitlab', labels = ['Services'])
dc_resource(name = 'gitlab-runner', labels = ['Services'])
dc_resource(name = 'postgres', labels = ['Services'])
dc_resource(name = 'redis', labels = ['Services'])

dc_resource(name = 'backstage-app', labels = ['Backstage'])
dc_resource(name = 'backstage-backend', labels = ['Backstage'])

local_resource('startup', cmd = 'startup.sh', auto_init = False, labels = ['Kubernetes-ArgoCD'])