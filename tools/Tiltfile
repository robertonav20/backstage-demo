DOCKER_GID_KEY = 'DOCKER_GID'
GITLAB_USER_KEY = 'GITLAB_USER'
GITLAB_PASSWORD_KEY = 'GITLAB_PASSWORD'
JENKINS_ADMIN_PASSWORD_KEY = 'JENKINS_ADMIN_PASSWORD'
JENKINS_ADMIN_USER_KEY = 'JENKINS_ADMIN_USER'
JENKINS_FOLDER_KEY = 'JENKINS_FOLDER'
POSTGRES_EXTENSIONS_KEY = 'POSTGRES_EXTENSIONS'
POSTGRES_DB_KEY = 'POSTGRES_DB'
POSTGRES_USER_KEY = 'POSTGRES_USER'
POSTGRES_PASSWORD_KEY = 'POSTGRES_PASSWORD'
POSTGRES_HOST_AUTH_METHOD_KEY = 'POSTGRES_HOST_AUTH_METHOD'

DOCKER_GID_VALUE = local(command='getent group docker | cut -d: -f3')
GITLAB_USER_VALUE = 'root'
GITLAB_PASSWORD_VALUE = '-rob123-'
JENKINS_ADMIN_PASSWORD_VALUE = 'backstage'
JENKINS_ADMIN_USER_VALUE = 'backstage'
JENKINS_FOLDER_VALUE = 'backstage-demo'
POSTGRES_EXTENSIONS_VALUE = 'pg_trgm,btree_gist'
POSTGRES_DB_VALUE = 'gitlabhq_production'
POSTGRES_USER_VALUE = 'gitlab'
POSTGRES_PASSWORD_VALUE = 'password'
POSTGRES_HOST_AUTH_METHOD_VALUE = 'trust'

os.putenv(DOCKER_GID_KEY, DOCKER_GID_VALUE)
os.putenv(GITLAB_USER_KEY, GITLAB_USER_VALUE)
os.putenv(GITLAB_PASSWORD_KEY, GITLAB_PASSWORD_VALUE)
os.putenv(JENKINS_ADMIN_PASSWORD_KEY, JENKINS_ADMIN_PASSWORD_VALUE)
os.putenv(JENKINS_ADMIN_USER_KEY, JENKINS_ADMIN_USER_VALUE)
os.putenv(JENKINS_FOLDER_KEY, JENKINS_FOLDER_VALUE)
os.putenv(POSTGRES_EXTENSIONS_KEY, POSTGRES_EXTENSIONS_VALUE)
os.putenv(POSTGRES_DB_KEY, POSTGRES_DB_VALUE)
os.putenv(POSTGRES_USER_KEY, POSTGRES_USER_VALUE)
os.putenv(POSTGRES_PASSWORD_KEY, POSTGRES_PASSWORD_VALUE)
os.putenv(POSTGRES_HOST_AUTH_METHOD_KEY, POSTGRES_HOST_AUTH_METHOD_VALUE)

docker_build(
    ref = 'gitlab-image',
    context = './gitlab',
    build_args = {
        DOCKER_GID_KEY: DOCKER_GID_VALUE,
        GITLAB_USER_KEY: GITLAB_USER_VALUE,
        GITLAB_PASSWORD_KEY: GITLAB_PASSWORD_VALUE,
        JENKINS_ADMIN_PASSWORD_KEY: JENKINS_ADMIN_PASSWORD_VALUE,
        JENKINS_ADMIN_USER_KEY: JENKINS_ADMIN_USER_VALUE,
        JENKINS_FOLDER_KEY: JENKINS_FOLDER_VALUE,
        POSTGRES_EXTENSIONS_KEY: POSTGRES_EXTENSIONS_VALUE,
        POSTGRES_DB_KEY: POSTGRES_DB_VALUE,
        POSTGRES_USER_KEY: POSTGRES_USER_VALUE,
        POSTGRES_PASSWORD_KEY: POSTGRES_PASSWORD_VALUE,
        POSTGRES_HOST_AUTH_METHOD_KEY: POSTGRES_HOST_AUTH_METHOD_VALUE
    }
)
docker_build(
    ref ='jenkins-image',
    context = './jenkins',
    build_args = {
        DOCKER_GID_KEY: DOCKER_GID_VALUE,
        GITLAB_USER_KEY: GITLAB_USER_VALUE,
        GITLAB_PASSWORD_KEY: GITLAB_PASSWORD_VALUE,
        JENKINS_ADMIN_PASSWORD_KEY: JENKINS_ADMIN_PASSWORD_VALUE,
        JENKINS_ADMIN_USER_KEY: JENKINS_ADMIN_USER_VALUE,
        JENKINS_FOLDER_KEY: JENKINS_FOLDER_VALUE,
        POSTGRES_EXTENSIONS_KEY: POSTGRES_EXTENSIONS_VALUE,
        POSTGRES_DB_KEY: POSTGRES_DB_VALUE,
        POSTGRES_USER_KEY: POSTGRES_USER_VALUE,
        POSTGRES_PASSWORD_KEY: POSTGRES_PASSWORD_VALUE,
        POSTGRES_HOST_AUTH_METHOD_KEY: POSTGRES_HOST_AUTH_METHOD_VALUE
    }
)

docker_compose( configPaths = './docker-compose.yaml')

dc_resource(name = 'gitlab', labels = ['Services'])
dc_resource(name = 'jenkins', labels = ['Services'])
dc_resource(name = 'postgres', labels = ['Services'])
dc_resource(name = 'redis', labels = ['Services'])
