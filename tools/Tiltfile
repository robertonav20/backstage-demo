DOCKER_GID_KEY = 'DOCKER_GID'
GITLAB_HOST_KEY = 'GITLAB_HOST'
GITLAB_URL_KEY = 'GITLAB_URL'
GITLAB_API_BASE_URL_KEY = 'GITLAB_API_BASE_URL'
GITLAB_USER_KEY = 'GITLAB_USER'
GITLAB_PASSWORD_KEY = 'GITLAB_PASSWORD'
GITLAB_GROUP_KEY = 'GITLAB_GROUP'
GITLAB_API_KEY_KEY = 'GITLAB_API_KEY'
GITLAB_RUNNER_API_KEY_KEY = 'GITLAB_RUNNER_API_KEY'
GITLAB_CLIENT_ID_KEY = 'GITLAB_CLIENT_ID'
GITLAB_CLIENT_SECRET_KEY = 'GITLAB_CLIENT_SECRET'
GITLAB_SCRIPTS_DIR_KEY = 'GITLAB_SCRIPTS_DIR'
GITLAB_TEMPLATES_DIR_KEY = 'GITLAB_TEMPLATES_DIR'
POSTGRES_EXTENSIONS_KEY = 'POSTGRES_EXTENSIONS'
POSTGRES_DB_KEY = 'POSTGRES_DB'
POSTGRES_USER_KEY = 'POSTGRES_USER'
POSTGRES_PASSWORD_KEY = 'POSTGRES_PASSWORD'
POSTGRES_HOST_AUTH_METHOD_KEY = 'POSTGRES_HOST_AUTH_METHOD'
KUBERNETES_API_BASE_URL_KEY = 'KUBERNETES_API_BASE_URL'
KUBERNETES_CLUSTER_NAME_KEY = 'KUBERNETES_CLUSTER_NAME'
KUBERNETES_SKIP_TLS_KEY = 'KUBERNETES_SKIP_TLS'
KUBERNETES_SKIP_METRICS_KEY = 'KUBERNETES_SKIP_METRICS'
KUBERNETES_CLIENT_CERTIFICATE_DATA_KEY = 'KUBERNETES_CLIENT_CERTIFICATE_DATA'
KUBERNETES_CLIENT_KEY_DATA_KEY = 'KUBERNETES_CLIENT_KEY_DATA'

DOCKER_GID_VALUE = local(command='getent group docker | cut -d: -f3')
GITLAB_HOST_VALUE = 'gitlab-local'
GITLAB_URL_VALUE = 'http://' + GITLAB_HOST_VALUE
GITLAB_API_BASE_URL_VALUE = GITLAB_URL_VALUE + '/api/v4'
GITLAB_USER_VALUE = 'root'
GITLAB_PASSWORD_VALUE = '-rob123-'
GITLAB_GROUP_VALUE = 'backstage-demo'
GITLAB_API_KEY_VALUE = 'glpat-zQ-yQ8VyW37oRSbEnWAx'
GITLAB_CLIENT_ID_VALUE = 'd3ea15baea5a9d72ed6a5fa2e42c71140a634bc374b0b0aaa01066a87e62ec62'
GITLAB_CLIENT_SECRET_VALUE = 'gloas-b1f8c16b11c2a90737b678ec970e0f0247aee65ae886e7dce89c65ae29a6bf67'
GITLAB_SCRIPTS_DIR_VALUE = '/scripts'
GITLAB_TEMPLATES_DIR_VALUE = GITLAB_SCRIPTS_DIR_VALUE + '/templates'
POSTGRES_EXTENSIONS_VALUE = 'pg_trgm,btree_gist'
POSTGRES_DB_VALUE = 'gitlabhq_production'
POSTGRES_USER_VALUE = 'gitlab'
POSTGRES_PASSWORD_VALUE = 'password'
POSTGRES_HOST_AUTH_METHOD_VALUE = 'trust'
KUBERNETES_API_BASE_URL_VALUE = 'https://localhost:6443'
KUBERNETES_CLUSTER_NAME_VALUE = 'kind-backstage-cluster'
KUBERNETES_SKIP_TLS_VALUE = 'true'
KUBERNETES_SKIP_METRICS_VALUE = 'true'
KUBERNETES_CLIENT_CERTIFICATE_DATA_VALUE = 'LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCVENDQWUyZ0F3SUJBZ0lJUFJNT3dkbno4T0l3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TkRFd01UUXhPREF4TlRCYUZ3MHpOREV3TVRJeE9EQTJOVEJhTUJVeApFekFSQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUUNpMnF6V1Rxa3ZBSzNGeVdSbTYvZC9MaVoxaWdBN0gxc0NLRUlFSy9lZ3BVcldyTGdEY3IxYVpSWS8KOXZuSjFHaEpObVpOdXhUZkJDTFFzL2dFTEw0aEszTEZ3eFZTdHpucGVmOFJTYzZVS0pVUURuSERJS1NKVnZMeQpZLzFVVFlkbEI1bHBHNXNJd2Y1WkVsUUJFWHRlVG1jRTFPVVdRY1AxNVkrQSsrV3dxVFVFbDlaQTF3UU44eGlOCk1HZTllZVRqRXBBZXRySnAwWTBtNGlyNEVOdFRYYWRvK1RoVjZ2bDZKMEZZWFMwYkxzVzBoVkVZaE1mY0xuYXUKOVIyalE0Zm0waFdWS0xibTZJanNLWS9jd0RsbGd5SUt5b28vdVZDL2lEOGl3YlRvOTN2S1llUllMYlQraytYNApxdExCUncwd0ppTnA4a2pWdko4TXNLVGNnVlg5QWdNQkFBR2pXVEJYTUE0R0ExVWREd0VCL3dRRUF3SUNwREFQCkJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXQkJReXpxU2ZQeHVCUEk5dENVaE5Ra0lWTW1NMUdqQVYKQmdOVkhSRUVEakFNZ2dwcmRXSmxjbTVsZEdWek1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQUlGaHdSWXpoTgpna2preXJvUC9aOVkrT0MrRUQ1TFlreVgrSFg1WjVYeWQwdE1Qa2dLc0VnbGc0UzBlZFp5UWo2Zm5XWDVUSEZ4CnJReVliRUdYSDE3MUFvUmV2MGErbGFid1M3SFNxemJXYSt1L1hvZzRBLzhlTzF2bGJFUFlQQTdQQjdjUXZua3AKU2tGQWpkL0pKcXlYWDJUZVYrVVpuMkRZTUwzTWtsWmhTdGtlTUFFQlRDS2RHT2cvZjNTbzVWYi9LVEdYR2xXLwp1Z01NKzExbGJva3BXSjAvQzd4VXE5MS9zYkgvU0xPWncrZmR1ZUhtSmt0TGlvRGhHQzd0OHl5a01hSzl2R2poCkJTQ25oQjE2cnd3V1ZBMU92ajdKTElyNmpyZHY0ZTRYZG9wZStnT0RJZW5qVGtFWG9UNmlHTDk1OGM1Tyt1T1IKQ3ZQNzBmbXZhVmx6Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K'
KUBERNETES_CLIENT_KEY_DATA_VALUE = 'eyJhbGciOiJSUzI1NiIsImtpZCI6IndiR2Q5YVE0RHJpUDV4UmNtOEVUVGRzTnRZWG1yMS1LNzEteFdzdEw1b3cifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImJhY2tzdGFnZS1zZWNyZXQiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiYmFja3N0YWdlLXNlcnZpY2UtYWNjb3VudCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImY4OTQwNjVkLWM0NmYtNGFmYi05OGY2LWQyMWRhZWJlMWRjYSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmJhY2tzdGFnZS1zZXJ2aWNlLWFjY291bnQifQ.hz8i9ZjinnJn32ya6fc6q20Zp0hO9kfUgZ0WGyb3jCQRxJAJHPW-M2C6iF7OCPx1pYiB8pHw1BViC6Vpleq4cJMLrShJmmvOa4NX6gZ3PFXab6I0zYumPpYd3ZeTkqI9iKlV7PWT-ZDkr00ysCAKPZTGlIKAA2l3EEocObf5x8alCeWLtteBxxdzA0y8ceyWgIQMuO7DUR0m9ZiVCJ6qUSZmOwcHc6q1gZ-A4HWf_wMFZ0-vw1guKpgHR-XZWILwY2yJYkQnOa2E9HK-5SWahZzqIhE6_pZtofP6bwxhGz9I72EXvpi-kOGEQASdfKxRd13JcVLkJwYBAbA7JTNDpg'

BUILD_ARGS = {
    DOCKER_GID_KEY: DOCKER_GID_VALUE,
    GITLAB_HOST_KEY: GITLAB_HOST_VALUE,
    GITLAB_URL_KEY: GITLAB_URL_VALUE,
    GITLAB_API_BASE_URL_KEY: GITLAB_API_BASE_URL_VALUE,
    GITLAB_USER_KEY: GITLAB_USER_VALUE,
    GITLAB_PASSWORD_KEY: GITLAB_PASSWORD_VALUE,
    GITLAB_GROUP_KEY: GITLAB_GROUP_VALUE,
    GITLAB_API_KEY_KEY: GITLAB_API_KEY_VALUE,
    GITLAB_CLIENT_ID_KEY: GITLAB_CLIENT_ID_VALUE,
    GITLAB_CLIENT_SECRET_KEY: GITLAB_CLIENT_SECRET_VALUE,
    GITLAB_SCRIPTS_DIR_KEY: GITLAB_SCRIPTS_DIR_VALUE,
    GITLAB_TEMPLATES_DIR_KEY: GITLAB_TEMPLATES_DIR_VALUE,
    POSTGRES_EXTENSIONS_KEY: POSTGRES_EXTENSIONS_VALUE,
    POSTGRES_DB_KEY: POSTGRES_DB_VALUE,
    POSTGRES_USER_KEY: POSTGRES_USER_VALUE,
    POSTGRES_PASSWORD_KEY: POSTGRES_PASSWORD_VALUE,
    POSTGRES_HOST_AUTH_METHOD_KEY: POSTGRES_HOST_AUTH_METHOD_VALUE,
    KUBERNETES_API_BASE_URL_KEY: KUBERNETES_API_BASE_URL_VALUE,
    KUBERNETES_CLUSTER_NAME_KEY: KUBERNETES_CLUSTER_NAME_VALUE,
    KUBERNETES_SKIP_TLS_KEY: KUBERNETES_SKIP_TLS_VALUE,
    KUBERNETES_SKIP_METRICS_KEY: KUBERNETES_SKIP_METRICS_VALUE,
    KUBERNETES_CLIENT_CERTIFICATE_DATA_KEY: KUBERNETES_CLIENT_CERTIFICATE_DATA_VALUE,
    KUBERNETES_CLIENT_KEY_DATA_KEY: KUBERNETES_CLIENT_KEY_DATA_VALUE,
}

os.putenv(DOCKER_GID_KEY, DOCKER_GID_VALUE)
os.putenv(GITLAB_HOST_KEY, GITLAB_HOST_VALUE)
os.putenv(GITLAB_URL_KEY, GITLAB_URL_VALUE)
os.putenv(GITLAB_API_BASE_URL_KEY, GITLAB_API_BASE_URL_VALUE)
os.putenv(GITLAB_USER_KEY, GITLAB_USER_VALUE)
os.putenv(GITLAB_PASSWORD_KEY, GITLAB_PASSWORD_VALUE)
os.putenv(GITLAB_GROUP_KEY, GITLAB_GROUP_VALUE)
os.putenv(GITLAB_API_KEY_KEY, GITLAB_API_KEY_VALUE)
os.putenv(GITLAB_CLIENT_ID_KEY, GITLAB_CLIENT_ID_VALUE)
os.putenv(GITLAB_CLIENT_SECRET_KEY, GITLAB_CLIENT_SECRET_VALUE)
os.putenv(GITLAB_SCRIPTS_DIR_KEY, GITLAB_SCRIPTS_DIR_VALUE)
os.putenv(GITLAB_TEMPLATES_DIR_KEY, GITLAB_TEMPLATES_DIR_VALUE)
os.putenv(POSTGRES_EXTENSIONS_KEY, POSTGRES_EXTENSIONS_VALUE)
os.putenv(POSTGRES_DB_KEY, POSTGRES_DB_VALUE)
os.putenv(POSTGRES_USER_KEY, POSTGRES_USER_VALUE)
os.putenv(POSTGRES_PASSWORD_KEY, POSTGRES_PASSWORD_VALUE)
os.putenv(POSTGRES_HOST_AUTH_METHOD_KEY, POSTGRES_HOST_AUTH_METHOD_VALUE)
os.putenv(KUBERNETES_API_BASE_URL_KEY, KUBERNETES_API_BASE_URL_VALUE)
os.putenv(KUBERNETES_CLUSTER_NAME_KEY, KUBERNETES_CLUSTER_NAME_VALUE)
os.putenv(KUBERNETES_SKIP_TLS_KEY, KUBERNETES_SKIP_TLS_VALUE)
os.putenv(KUBERNETES_SKIP_METRICS_KEY, KUBERNETES_SKIP_METRICS_VALUE)
os.putenv(KUBERNETES_CLIENT_CERTIFICATE_DATA_KEY, KUBERNETES_CLIENT_CERTIFICATE_DATA_VALUE)
os.putenv(KUBERNETES_CLIENT_KEY_DATA_KEY, KUBERNETES_CLIENT_KEY_DATA_VALUE)

docker_build(
    ref = 'gitlab-image',
    context = './gitlab',
    build_args = BUILD_ARGS,
)
docker_build(
    ref = 'gitlab-runner-image',
    context = './gitlab-runner',
    build_args = BUILD_ARGS,
)

docker_build(
    ref = 'backstage-app-image',
    context = '../',
    dockerfile = './backstage-app/Dockerfile',
    live_update = [
        # when package.json changes, we need to do a full build
        fall_back_on(['./packages/app/package.json']),
        # Map the local source code into the container under /src
        sync('./packages/app/public', '/app/public'),
        sync('./packages/app/src', '/app/src'),
        sync('./app-config.yaml', '/app/app-config.yaml'),
    ],
    build_args = BUILD_ARGS
)

docker_build(
    ref = 'backstage-backend-image',
    context = '../',
    dockerfile = './backstage-backend/Dockerfile',
    live_update=[
        # when package.json changes, we need to do a full build
        fall_back_on(['./packages/backend/package.json']),
        # Map the local source code into the container under /src
        sync('./packages/backend/static', '/app/static'),
        sync('./packages/backend/src', '/app/src'),
        sync('./app-config.yaml', '/app/app-config.yaml'),
    ],
    build_args = BUILD_ARGS
)

docker_compose( configPaths = './docker-compose.yaml')

dc_resource(name = 'gitlab', labels = ['Services'])
dc_resource(name = 'gitlab-runner', labels = ['Services'])
dc_resource(name = 'postgres', labels = ['Services'])
dc_resource(name = 'redis', labels = ['Services'])

dc_resource(name = 'backstage-app', labels = ['Backstage'])
dc_resource(name = 'backstage-backend', labels = ['Backstage'])