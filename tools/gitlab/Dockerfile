FROM gitlab/gitlab-ce:17.5.0-ce.0

RUN apt-get update && apt-get install -qyy jq

ARG GITLAB_HOST=gitlab-local
ARG GITLAB_URL=http://gitlab-local
ARG GITLAB_USER
ARG GITLAB_PASSWORD
ARG GITLAB_GROUP=backstage-demo
ARG GITLAB_API_KEY
ARG GITLAB_CLIENT_ID
ARG GITLAB_CLIENT_SECRET
ARG GITLAB_SCRIPTS_DIR="/scripts"
ARG GITLAB_TEMPLATES_DIR="/scripts/templates"

ENV GITLAB_HOST=$GITLAB_HOST
ENV GITLAB_URL=$GITLAB_URL
ENV GITLAB_USER=$GITLAB_USER
ENV GITLAB_PASSWORD=$GITLAB_PASSWORD
ENV GITLAB_GROUP=$GITLAB_GROUP
ENV GITLAB_API_KEY=$GITLAB_API_KEY
ENV GITLAB_CLIENT_ID=$GITLAB_CLIENT_ID
ENV GITLAB_CLIENT_SECRET=$GITLAB_CLIENT_SECRET
ENV GITLAB_SCRIPTS_DIR=$GITLAB_SCRIPTS_DIR
ENV GITLAB_TEMPLATES_DIR=$GITLAB_TEMPLATES_DIR

RUN mkdir -p $GITLAB_TEMPLATES_DIR

COPY ./gitlab-startup.sh $GITLAB_SCRIPTS_DIR
COPY ./gitlab-templates.sh $GITLAB_SCRIPTS_DIR
COPY ./templates $GITLAB_TEMPLATES_DIR

RUN chmod +xr $GITLAB_SCRIPTS_DIR/gitlab-startup.sh
RUN chmod +xr $GITLAB_SCRIPTS_DIR/gitlab-templates.sh